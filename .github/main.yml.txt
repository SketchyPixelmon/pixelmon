name: Start Pixelmon Server

on:
  workflow_dispatch:

jobs:
  start-server:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository Files
        uses: actions/checkout@v4

      - name: 2. Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: 3. Download Server Jars
        run: |
          echo "Downloading Arclight Server Jar..."
          wget -q -O arclight-server.jar "https://github.com/IzzelAliz/Arclight/releases/download/1.2.1-1.16.5/arclight-forge-1.16.5-1.2.1-SNAPSHOT.jar"
          
          echo "Downloading Pixelmon Mod Jar..."
          wget -q -O mods/pixelmon.jar "https://reforged.gg/downloads/pixelmon/9.1.13/pixelmon-1.16.5-9.1.13-server.jar"
          echo "Downloads Complete."
          
      - name: 4. Configure Rclone
        run: |
          echo "Setting up Rclone..."
          sudo curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf
          echo "Rclone configured."
          
      - name: 5. Sync World Data from Cloud
        run: |
          echo "Syncing world data from Google Drive..."
          rclone sync gdrive:Minecraft_Server_Data . -P
          echo "Sync complete."
          
      - name: 6. Start Server and Tunnel
        run: |
          echo "Starting Ngrok tunnel..."
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok tcp 25565 &> /dev/null &

          echo "Waiting for Ngrok IP..."
          sleep 10
          export NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "Sending IP to Discord..."
          curl -H "Content-Type: application/json" \
               -d '{"content": "✅ **Pixelmon Server is Online!**\nJoin at: `'"$NGROK_URL"'`"}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
               
          echo "Starting Minecraft Server..."
          java -Xmx6G -Xms6G -jar arclight-server.jar nogui
          
      - name: 7. (Shutdown) Sync World Data to Cloud
        if: always()
        run: |
          echo "Server is shutting down. Syncing world to cloud..."
          curl -H "Content-Type: application/json" \
               -d '{"content": "❌ **Server is Offline.**\nSaving world data now."}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
          rclone sync . gdrive:Minecraft_Server_Data -P --include "/world/**" --include "/plugins/GriefPreventionData/**"
          echo "Sync to cloud complete."