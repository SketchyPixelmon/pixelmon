name: Minecraft Server

on:
  workflow_dispatch:

jobs:
  server:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

    - name: Restore World Data
      run: |
        rclone copy gdrive:Minecraft_Server_Data/world ./world -P
        rclone copy gdrive:Minecraft_Server_Data/plugins ./plugins -P
        rclone copy gdrive:Minecraft_Server_Data/usercache.json ./usercache.json

    - name: Start Server
      run: ./start.sh

    - name: Sync World Data Back
      if: always()
      run: |
        rclone sync ./world gdrive:Minecraft_Server_Data/world -P
        rclone sync ./plugins gdrive:Minecraft_Server_Data/plugins -P
        rclone copy ./usercache.json gdrive:Minecraft_Server_Data/usercache.json
